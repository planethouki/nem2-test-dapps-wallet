const account = require('../../src/assets/utils/account')
const helper = require('../../src/assets/utils/helper')

jest.mock('axios')

describe('account', () => {

  const privateKey1 = '25B3F54217340F7061D02676C4B928ADB4395EB70A2A52D2A11E2F4AE011B03E'
  const privateKey2 = '35B3F54217340F7061D02676C4B928ADB4395EB70A2A52D2A11E2F4AE011B03E'
  const privateKey3 = '45B3F54217340F7061D02676C4B928ADB4395EB70A2A52D2A11E2F4AE011B03E'
  const publicKey1 = 'C65B49BA7673BFEC3EFD04DE7EF412A6346F4BA745AAC09649E8CAFE1AC38580'
  const generationHash = '3B5E1FA6445653C971A50687E75E6D09FB30481055E3990C84B25E9222DC1155'

  describe('sign', () => {
    test('transferTransaction', () => {
      const signedTransaction =  {
        payload: 'BB0000000000000041357A89184452E4AF71B47DA654D84B6B2BD486D2D0E656EE59F97FD4191EC117ACC5ABED543DCF6B8D359FAB6BCBD70BB8517B6EB487F75DD00ADDDD6EDD0DC65B49BA7673BFEC3EFD04DE7EF412A6346F4BA745AAC09649E8CAFE1AC385800000000001985441A0860100000000006E8CFA66020000009814F3DABC922F7B2D06A6AF544B58E5CFA2099C91B0077C0B000100000000003CE19A057E831F0900E40B540200000000386D544575416932746A',
        hash: 'F70A1641B74CEB777A3165BA5751806FFDDC3E2F634220DE566EF39C85E26AEC',
        signerPublicKey: 'C65B49BA7673BFEC3EFD04DE7EF412A6346F4BA745AAC09649E8CAFE1AC38580',
        type: 16724,
        networkType: 152
      }

      const expectSignature = signedTransaction.payload.substr((8) * 2, (64) * 2)

      const unsignedPayload = helper.spliceSignature(
        signedTransaction.payload,
        "".padStart(128, "0"),
        "".padStart(64, "0")
      )

      expect(account.sign(privateKey1, unsignedPayload, generationHash)).toBe(expectSignature)
    })

    test('aggregateBondedTransaction', () => {
      const signedTransaction = {
        payload: '18010000000000003C368796C3B8C8F619F6E60B8E600BE69CA6A7F4CE0F555EC47789AB2FEDCA60A547A8882EB853A6CF0DA44A040775E929944F3709F183FC7ED5021ACEF2F50CC65B49BA7673BFEC3EFD04DE7EF412A6346F4BA745AAC09649E8CAFE1AC385800000000001984142400D0300000000002C11C6BB020000008A41A038B7AE52490E97FD2FB5E95AB154A98D5AB60A56263A3C1A624731DC2D70000000000000006B00000000000000C65B49BA7673BFEC3EFD04DE7EF412A6346F4BA745AAC09649E8CAFE1AC3858000000000019854419814F3DABC922F7B2D06A6AF544B58E5CFA2099C91B0077C0B000100000000003CE19A057E831F0900E40B540200000000386D544575416932746A0000000000',
        hash: '2CC57BF4235322C01369FF227BB2E5307C38EC23229186331DFA16E5B785CDDE',
        signerPublicKey: 'C65B49BA7673BFEC3EFD04DE7EF412A6346F4BA745AAC09649E8CAFE1AC38580',
        type: 16961,
        networkType: 152
      }

      const expectSignature = signedTransaction.payload.substr((8) * 2, (64) * 2)

      const unsignedPayload = helper.spliceSignature(
        signedTransaction.payload,
        "".padStart(128, "0"),
        "".padStart(64, "0")
      )

      expect(account.sign(privateKey1, unsignedPayload, generationHash)).toBe(expectSignature)
    })

    test('aggregateCompleteTransaction', () => {
      const signedTransaction = {
        payload: '18010000000000006FA8A4F96E16739546F99351721D0E44938E3D6A26BBF69E12A6C1D63EAA4E6DBEDC15F02BED62107C27012B58FAA69C91412A9AE8F72136D62CAD7DDA940809C65B49BA7673BFEC3EFD04DE7EF412A6346F4BA745AAC09649E8CAFE1AC385800000000001984141400D030000000000C10CC0BB020000008A41A038B7AE52490E97FD2FB5E95AB154A98D5AB60A56263A3C1A624731DC2D70000000000000006B00000000000000C65B49BA7673BFEC3EFD04DE7EF412A6346F4BA745AAC09649E8CAFE1AC3858000000000019854419814F3DABC922F7B2D06A6AF544B58E5CFA2099C91B0077C0B000100000000003CE19A057E831F0900E40B540200000000386D544575416932746A0000000000',
        hash: '7AD7C2B2F7B2CA3CB347DDAEF114E3DDCE330CFB35C0E57B5DFEF0E9D770CE87',
        signerPublicKey: 'C65B49BA7673BFEC3EFD04DE7EF412A6346F4BA745AAC09649E8CAFE1AC38580',
        type: 16705,
        networkType: 152
      }

      const expectSignature = signedTransaction.payload.substr((8) * 2, (64) * 2)

      const unsignedPayload = helper.spliceSignature(
        signedTransaction.payload,
        "".padStart(128, "0"),
        "".padStart(64, "0")
      )

      expect(account.sign(privateKey1, unsignedPayload, generationHash)).toBe(expectSignature)
    })
  })

  describe('cosign', () => {
    test('aggregateCompleteTransactionWithNoCoSign', () => {
      // Arguments for nem2.cosign. Must be signed by privateKey1 and privateKey2; only privateKey1 signed.
      const signedTransaction = {
        payload: '880100000000000087577A911E6D444B7A3B15ACDCFA1DFA530E49553CD38C5BC6685628B917C68CDACA137C356322085F547CFBE291119A1FF2503EBF7A2771937F7CB541583408C65B49BA7673BFEC3EFD04DE7EF412A6346F4BA745AAC09649E8CAFE1AC385800000000001984141400D030000000000EA901BD90200000026C4A9A4E58478E827AC8A512CD92C0CD54E587661D288B8008EC6CDB5500462E0000000000000006B00000000000000C65B49BA7673BFEC3EFD04DE7EF412A6346F4BA745AAC09649E8CAFE1AC3858000000000019854419814F3DABC922F7B2D06A6AF544B58E5CFA2099C91B0077C0B000100000000003CE19A057E831F0900E40B540200000000386D544575416932746A00000000006B000000000000007105CBCCCAE60929A908BDB0C8FD475A44CAAB9C33D7482A9F1840541F12DA4900000000019854419814F3DABC922F7B2D06A6AF544B58E5CFA2099C91B0077C0B000100000000003CE19A057E831F0900E40B540200000000386D544575416932746A0000000000',
        hash: '8AABCBE55D02E208D3E0BDCE66BA8F9C7CF87FFF4FE957179503E848436CAC46',
        signerPublicKey: 'C65B49BA7673BFEC3EFD04DE7EF412A6346F4BA745AAC09649E8CAFE1AC38580',
        type: 16705,
        networkType: 152
      }
      // Same as above, except co-signed. Signed by privateKey1 and co-signed by privateKey2.
      const cosignedTransaction = {
        payload: 'f00100000000000087577A911E6D444B7A3B15ACDCFA1DFA530E49553CD38C5BC6685628B917C68CDACA137C356322085F547CFBE291119A1FF2503EBF7A2771937F7CB541583408C65B49BA7673BFEC3EFD04DE7EF412A6346F4BA745AAC09649E8CAFE1AC385800000000001984141400D030000000000EA901BD90200000026C4A9A4E58478E827AC8A512CD92C0CD54E587661D288B8008EC6CDB5500462E0000000000000006B00000000000000C65B49BA7673BFEC3EFD04DE7EF412A6346F4BA745AAC09649E8CAFE1AC3858000000000019854419814F3DABC922F7B2D06A6AF544B58E5CFA2099C91B0077C0B000100000000003CE19A057E831F0900E40B540200000000386D544575416932746A00000000006B000000000000007105CBCCCAE60929A908BDB0C8FD475A44CAAB9C33D7482A9F1840541F12DA4900000000019854419814F3DABC922F7B2D06A6AF544B58E5CFA2099C91B0077C0B000100000000003CE19A057E831F0900E40B540200000000386D544575416932746A000000000000000000000000007105CBCCCAE60929A908BDB0C8FD475A44CAAB9C33D7482A9F1840541F12DA494AAE1956F2B9922FAA96B1C6BF10217CF0105C5420CBE2D9ADFC0ECCB2581B579CA8EE36C2D9ADE62A78F0AE588E43A3674E7956FEADE354D882B8CCAD472205',
        hash: '8AABCBE55D02E208D3E0BDCE66BA8F9C7CF87FFF4FE957179503E848436CAC46',
        signerPublicKey: 'C65B49BA7673BFEC3EFD04DE7EF412A6346F4BA745AAC09649E8CAFE1AC38580',
        type: 16705,
        networkType: 152
      }
      const expectedCosig = cosignedTransaction.payload.substring((0x01f0 - 64) * 2, 0x01f0 * 2)
      const cosignature = account.cosign(privateKey2, signedTransaction.hash)
      expect(cosignature).toBe(expectedCosig)
    })

    test('aggregateTransactionWithCosign', () => {
      // Arguments for nem2.cosign. Must be signed by privateKey1, privateKey2 and privateKey3; only privateKey1 signed and privateKey2 co-signed.
      const signedTransaction = {
        payload: '600200000000000080274BA6E9BC0B50C205E8C47F61517BAC9CF9D122E65593EE935C65F7F5718D18801336C532F5D6DC6D812C61A6266FCD862C3D9B5A243909E054D206776A04C65B49BA7673BFEC3EFD04DE7EF412A6346F4BA745AAC09649E8CAFE1AC385800000000001984141400D030000000000837D89E202000000D5D9F762FB38AF80D4F41B5D8748B184103F15B4ED19865ADA173E9887BF5F1450010000000000006B00000000000000C65B49BA7673BFEC3EFD04DE7EF412A6346F4BA745AAC09649E8CAFE1AC3858000000000019854419814F3DABC922F7B2D06A6AF544B58E5CFA2099C91B0077C0B000100000000003CE19A057E831F0900E40B540200000000386D544575416932746A00000000006B000000000000007105CBCCCAE60929A908BDB0C8FD475A44CAAB9C33D7482A9F1840541F12DA4900000000019854419814F3DABC922F7B2D06A6AF544B58E5CFA2099C91B0077C0B000100000000003CE19A057E831F0900E40B540200000000386D544575416932746A00000000006B00000000000000C5B39DD416AD3424FED68298229A27B199271004C3D81001B11E89A11FA8C69400000000019854419814F3DABC922F7B2D06A6AF544B58E5CFA2099C91B0077C0B000100000000003CE19A057E831F0900E40B540200000000386D544575416932746A000000000000000000000000007105CBCCCAE60929A908BDB0C8FD475A44CAAB9C33D7482A9F1840541F12DA495C5F91BC9B298D9CF38A1046509929796867130C6BFA3F27C18DA5F3E1CEA20C32DD9BA75BBB61E6760F96AFB7C40B66FD2B9D22AEB0C2275008B48CCE6BF502',
        hash: '974EC0F0CCC8DF5E5EB889C4924159745ED463A21E1A1CB7C10095E964D3D7AB',
        signerPublicKey: 'C65B49BA7673BFEC3EFD04DE7EF412A6346F4BA745AAC09649E8CAFE1AC38580',
        type: 16705,
        networkType: 152
      }
      // Same as above, except co-signed. Signed by privateKey1 and co-signed by privateKey2 and privateKey3.
      const cosignedTransaction = {
        payload: 'c80200000000000080274BA6E9BC0B50C205E8C47F61517BAC9CF9D122E65593EE935C65F7F5718D18801336C532F5D6DC6D812C61A6266FCD862C3D9B5A243909E054D206776A04C65B49BA7673BFEC3EFD04DE7EF412A6346F4BA745AAC09649E8CAFE1AC385800000000001984141400D030000000000837D89E202000000D5D9F762FB38AF80D4F41B5D8748B184103F15B4ED19865ADA173E9887BF5F1450010000000000006B00000000000000C65B49BA7673BFEC3EFD04DE7EF412A6346F4BA745AAC09649E8CAFE1AC3858000000000019854419814F3DABC922F7B2D06A6AF544B58E5CFA2099C91B0077C0B000100000000003CE19A057E831F0900E40B540200000000386D544575416932746A00000000006B000000000000007105CBCCCAE60929A908BDB0C8FD475A44CAAB9C33D7482A9F1840541F12DA4900000000019854419814F3DABC922F7B2D06A6AF544B58E5CFA2099C91B0077C0B000100000000003CE19A057E831F0900E40B540200000000386D544575416932746A00000000006B00000000000000C5B39DD416AD3424FED68298229A27B199271004C3D81001B11E89A11FA8C69400000000019854419814F3DABC922F7B2D06A6AF544B58E5CFA2099C91B0077C0B000100000000003CE19A057E831F0900E40B540200000000386D544575416932746A000000000000000000000000007105CBCCCAE60929A908BDB0C8FD475A44CAAB9C33D7482A9F1840541F12DA495C5F91BC9B298D9CF38A1046509929796867130C6BFA3F27C18DA5F3E1CEA20C32DD9BA75BBB61E6760F96AFB7C40B66FD2B9D22AEB0C2275008B48CCE6BF5020000000000000000C5B39DD416AD3424FED68298229A27B199271004C3D81001B11E89A11FA8C69462015C769F7AC7EC5A4BB29C8E877A4B85D8822C30E41CE28D80AE898F175E4091F2C7E46B2DA1493BB614C0BA379390424F7991D34A41794202AA3D91EDC007',
          hash: '974EC0F0CCC8DF5E5EB889C4924159745ED463A21E1A1CB7C10095E964D3D7AB',
          signerPublicKey: 'C65B49BA7673BFEC3EFD04DE7EF412A6346F4BA745AAC09649E8CAFE1AC38580',
          type: 16705,
          networkType: 152
      }
      const pubA = cosignedTransaction.payload
        .substring((0x02c8 - 64 - 32) * 2, (0x02c8 - 64) * 2)
      const pubB = cosignedTransaction.payload
        .substring((0x02c8 - 64 - 32 - 8 - 64 - 32) * 2, (0x02c8 - 64 - 32 - 8 - 64) * 2)
      const expectedCosig = {
        [pubA]: cosignedTransaction.payload.substring((0x02c8 - 64) * 2, 0x02c8 * 2),
        [pubB]: cosignedTransaction.payload.substring((0x02c8 - 64 - 32 - 8 - 64) * 2, (0x02c8 - 64 - 32 - 8) * 2)
      }
      const pub3 = account.privateKeyToPublicKey(privateKey3)
      const cosignature = account.cosign(privateKey3, signedTransaction.hash)
      expect(cosignature).toBe(expectedCosig[pub3])
    })

    test('aggregateBondedWithNoCosign', () => {
      const signedTransaction = {
        payload: '88010000000000004DFD5FB5A484CD5B9F2CE0958E86634CD627997525A9ED3FC49FF0FEDD5D375DB5C9756FFFFF92A3ED240E3B0FBB6079AB49DDDB795C869FBACDFCE8D4CC5C0AC65B49BA7673BFEC3EFD04DE7EF412A6346F4BA745AAC09649E8CAFE1AC385800000000001984142400D030000000000CC42ABE20200000026C4A9A4E58478E827AC8A512CD92C0CD54E587661D288B8008EC6CDB5500462E0000000000000006B00000000000000C65B49BA7673BFEC3EFD04DE7EF412A6346F4BA745AAC09649E8CAFE1AC3858000000000019854419814F3DABC922F7B2D06A6AF544B58E5CFA2099C91B0077C0B000100000000003CE19A057E831F0900E40B540200000000386D544575416932746A00000000006B000000000000007105CBCCCAE60929A908BDB0C8FD475A44CAAB9C33D7482A9F1840541F12DA4900000000019854419814F3DABC922F7B2D06A6AF544B58E5CFA2099C91B0077C0B000100000000003CE19A057E831F0900E40B540200000000386D544575416932746A0000000000',
        hash: 'B594FA8AC114EBF5CF064339CB1FF3DC62881EE1637E7DA09816CA6C7012E502',
        signerPublicKey: 'C65B49BA7673BFEC3EFD04DE7EF412A6346F4BA745AAC09649E8CAFE1AC38580',
        type: 16961,
        networkType: 152
      }
      const cosignedTransaction = {
        payload: 'f0010000000000004DFD5FB5A484CD5B9F2CE0958E86634CD627997525A9ED3FC49FF0FEDD5D375DB5C9756FFFFF92A3ED240E3B0FBB6079AB49DDDB795C869FBACDFCE8D4CC5C0AC65B49BA7673BFEC3EFD04DE7EF412A6346F4BA745AAC09649E8CAFE1AC385800000000001984142400D030000000000CC42ABE20200000026C4A9A4E58478E827AC8A512CD92C0CD54E587661D288B8008EC6CDB5500462E0000000000000006B00000000000000C65B49BA7673BFEC3EFD04DE7EF412A6346F4BA745AAC09649E8CAFE1AC3858000000000019854419814F3DABC922F7B2D06A6AF544B58E5CFA2099C91B0077C0B000100000000003CE19A057E831F0900E40B540200000000386D544575416932746A00000000006B000000000000007105CBCCCAE60929A908BDB0C8FD475A44CAAB9C33D7482A9F1840541F12DA4900000000019854419814F3DABC922F7B2D06A6AF544B58E5CFA2099C91B0077C0B000100000000003CE19A057E831F0900E40B540200000000386D544575416932746A000000000000000000000000007105CBCCCAE60929A908BDB0C8FD475A44CAAB9C33D7482A9F1840541F12DA49508A8CD16316F195D1D59FBD39AB7832E21538F39FF878B4F229111D182F13AA2E968BA92B7B5C3381010557B9697328EF4246B0BCB59AAD5C3DA47FA814880E',
          hash: 'B594FA8AC114EBF5CF064339CB1FF3DC62881EE1637E7DA09816CA6C7012E502',
          signerPublicKey: 'C65B49BA7673BFEC3EFD04DE7EF412A6346F4BA745AAC09649E8CAFE1AC38580',
          type: 16961,
          networkType: 152
      }
      const expectedCosig = cosignedTransaction.payload.substring((0x01f0 - 64) * 2, 0x01f0 * 2)
      const cosignature = account.cosign(privateKey2, signedTransaction.hash)
      expect(cosignature).toBe(expectedCosig)
    })
  })

  test('privateKeyToPublicKey', () => {
    expect(account.privateKeyToPublicKey(privateKey1)).toBe(publicKey1)
  })
})
